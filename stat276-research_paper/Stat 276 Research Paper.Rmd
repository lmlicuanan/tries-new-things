---
title: "Stat 276 Research Paper"
author: "Lino Licuanan"
date: "12/28/2021"
output: html_document
---

## Abstract

With the increasing rate of adoption of fully digital banking over recent years in the Philippines, traditional banks are at high risk of disruption, and with good reason -- digital banks are cheaper to operate and therefore offer higher returns to the average Filipino. Despite this consumer benefit however, the financial ecosystem will never lose a place for physical banking. Traditional banks, therefore, need to operate with greater precision to maximize profitability. The study focused on providing recommendations to bank decision makers on where to strategically place new branches given a certain area's level of economic activity. Operating under the assumption that branch ubiquity is a good proxy for an area being conducive for physical branches, randomly generated points made to measure the number of banks within a 500-meter radius were spatially interpolated across the city of Makati. This was detrended on counts of points of interest. The findings of the study suggest specific points of interest as predictive of conduciveness for branch placement.

## Introduction

## Data and Preprocessing 

```{r, warning=FALSE}

suppressPackageStartupMessages({
  library(osmdata)
  library(tidyverse)
  library(sf)
  library(tmap)
  library(gstat)
  library(stars)
  library(magrittr)
  library(ggpubr)
  library(spdep)
})

httr::set_config(httr::config(ssl_verifypeer = FALSE))

study_region.bb <- getbb("Makati", format_out = "polygon") %>% head(1)

building.ql <- 
  study_region.bb %>% opq() %>% 
  add_osm_feature(key = "building")

road.ql <- 
  study_region.bb %>% opq() %>% 
  add_osm_feature(key = "highway")

city.ql <- 
  study_region.bb %>% opq() %>% 
  add_osm_feature(key = "admin_level", value = "6")

boundary.ql <- 
  study_region.bb %>% opq() %>% 
  add_osm_feature(key = "admin_level", value = "10")

amenity.ql <- 
  study_region.bb %>% opq() %>% 
  add_osm_feature(key = "amenity")

building.sf     <- building.ql %>% osmdata_sf() %>% trim_osmdata(study_region.bb)
road.sf         <- road.ql %>% osmdata_sf() %>% trim_osmdata(study_region.bb)
boundary.sf     <- boundary.ql %>% osmdata_sf() %>% trim_osmdata(study_region.bb)
city.sf         <- city.ql %>% osmdata_sf() %>% trim_osmdata(study_region.bb)

# left untrimmed to factor in edge correction
amenity.sf      <- amenity.ql %>% osmdata_sf()
# only randomly sample in areas where there is a known building
set.seed(2022)
mc_point.sf     <- st_as_sf(st_sample(city.sf$osm_multipolygons, 22 * 16))

httr::set_config(httr::config(ssl_verifypeer = TRUE))

amenity_point.sf <- amenity.sf$osm_points %>% 
  transmute(
    amenity = case_when(
      amenity == "bank" ~ "bank",
      amenity %in% c("restaurant", "fast_food") ~ "restaurant",
      amenity %in% c("bar", "pub", "gambling", "nightclub", "casino") ~ "bar",
      amenity %in% c("bus_station", "taxi", "ferry_terminal") ~ "terminal",
      amenity %in% c("clinic", "hospital", "doctors", "dentist") ~ "hc_facility",
      amenity == "pharmacy" ~ "pharmacy",
      amenity %in% c("school", "college") ~ "school",
      amenity == "place_of_worship" ~ "place_of_worship",
      TRUE ~ NA_character_
    ), value = TRUE
  ) %>% mutate(amenity_key = amenity) %>% 
  filter(!is.na(amenity)) %>% spread(key = amenity_key, value = value, fill = FALSE)

ggplot() + 
  geom_sf(data = building.sf$osm_polygons) +
  geom_sf(data = road.sf$osm_lines) +
  geom_sf(data = amenity_point.sf, aes(group = amenity, colour = amenity), alpha = 0.8) +
  scale_colour_viridis_d() +
  scale_size_continuous(guide = "none") + 
  labs(
    title = "Points of Interest in the City of Makati, Philippines", 
    caption = "Data from OpenStreetMap"
  )
```

```{r, warning=FALSE}
mc_point_params.sf <- aggregate(
  amenity_point.sf,
  mc_point.sf,
  FUN = function(x) sum(as.logical(x), na.rm = TRUE),
  join = function(x, y) st_is_within_distance(x, y, dist = 250)
) %>% filter(!is.na(amenity))

ggplot() +
  geom_sf(data = building.sf$osm_polygons) +
  geom_sf(data = road.sf$osm_lines) +
  geom_sf(data = amenity.sf$osm_points %>% filter(amenity == "bank"), col = "red", alpha = 0.8) +
  geom_sf(data = mc_point_params.sf, aes(colour = bank, size = bank, alpha = 0.8)) +
  scale_colour_viridis_c() +
  scale_size_continuous(guide = "none")

ggplot() +
  geom_sf(data = building.sf$osm_polygons) +
  geom_sf(data = road.sf$osm_lines) +
  geom_sf(data = amenity_point.sf %>% filter(!bank), 
          aes(group = amenity, colour = amenity),
          alpha = 0.8) +
  geom_sf(data = mc_point_params.sf, aes(alpha = bank, size = bank), col = "red") +
  scale_colour_viridis_d()
```

## Methods

```{r, warning=FALSE}
variogram <- variogram(
  bank ~ restaurant + bar + terminal + hc_facility + pharmacy + school + place_of_worship, 
  mc_point_params.sf %>% filter(!is.na(bank))
)
variogram.model <- fit.variogram(variogram, vgm("Ste"))
variogram.predicted <- variogramLine(variogram.model, maxdist = max(variogram$dist))

ggplot(variogram, aes(x = dist, y = gamma)) +
  geom_point() +
  geom_line(data = variogram.predicted, col = "blue") +
  labs(x = "distance", y = "semivariance")

city.rs <- city.sf$osm_multipolygons %>% st_rasterize()

city_params.sf <- aggregate(
  amenity_point.sf,
  st_as_sf(city.rs),
  FUN = function(x) sum(as.logical(x), na.rm = TRUE),
  join = function(x, y) st_is_within_distance(x, y, dist = 250)
) %>% filter(!is.na(amenity))

city_params.rs <- city_params.sf %>% st_rasterize()

k = krige(
  bank ~ restaurant + bar + terminal + hc_facility + pharmacy + school + place_of_worship, 
  mc_point_params.sf %>% st_set_crs("EPSG:4326"),
  city_params.rs %>% st_set_crs("EPSG:4326"), variogram.model
)

```

## Results and Discussion

```{r}
predicted <- ggplot() + 
  geom_stars(data = k %>% mutate(bank = var1.pred), aes(fill = bank, x = x, y = y)) +
  scale_fill_continuous(na.value = NA, low = "dark blue", high = "red") +
  lims(x = c(120.9987708, 121.0675029), y = c(14.5296336, 14.5794322)) +
  labs(subtitle = "Predicted")

predicted.var <- ggplot() + 
  geom_stars(data = k %>% mutate(bank = var1.var), aes(fill = bank, x = x, y = y)) +
  scale_fill_continuous(na.value = NA, low = "dark blue", high = "red") +
  lims(x = c(120.9987708, 121.0675029), y = c(14.5296336, 14.5794322)) +
  labs(subtitle = "Predicted")

actual <- ggplot() + 
  geom_stars(data = city_params.rs, aes(fill = bank, x = x, y = y)) +
  scale_fill_continuous(na.value = NA, low = "dark blue", high = "red") +
  lims(x = c(120.9987708, 121.0675029), y = c(14.5296336, 14.5794322)) + 
  labs(subtitle = "Actual")

theme <- theme(
  axis.text.x  = element_blank(),
  axis.text.y  = element_blank(),
  axis.ticks.x = element_blank(),
  axis.ticks.y = element_blank(),
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
)

ggarrange(
  predicted + theme, actual + theme,
  ncol = 2, nrow = 1,
  font.label = list(size = 8),
  common.legend = TRUE,
  legend = "bottom"
) %>% 
  annotate_figure(
    top = text_grob(
      "Banks Ubiquity in the city of Makati, Philippines", 
      face = "bold", size = 9
    ))

predicted.dt <- k %>% as_tibble() %>% 
  filter(!is.na(var1.pred)) %>% 
  mutate(predicted = var1.pred)
actual.dt <- city_params.rs %>% as_tibble() %>% 
  filter(!is.na(bank)) %>% 
  mutate(actual = bank)
evaluation.dt <- predicted.dt %>% 
  inner_join(actual.dt, by = c("x" = "x", "y" = "y"))

evaluation.dt %>% 
  mutate(se = (actual - predicted)^2) %>% 
  summarise(sqrt(mean(x)))

ggplot(evaluation.dt) + geom_histogram(aes(actual), binwidth = 1)

mean(evaluation.dt$actual) - mean(evaluation.dt$predicted)
```


## Conclusions